- name: Deploy FastAPI app with Docker, k3d, and Kubernetes
  hosts: web
  become: yes

  vars:
    app_dir: /opt/my-fastapi-app
    repo_url: https://github.com/Maged-Elshaarawy/my-fastapi-app.git

    docker_packages:
      - docker-ce
      - docker-ce-cli
      - containerd.io
      - docker-buildx-plugin
      - docker-compose-plugin

    k3d_version: v5.6.0
    kubectl_version: v1.30.0
    k3d_cluster_name: fastapi-cluster
    app_user: ubuntu

  tasks:
    # ---------------- System Prep ----------------
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install base dependencies
      apt:
        name:
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
          - git
        state: present

    # ---------------- Docker Install ----------------
    - name: Ensure Docker keyrings directory exists
      file:
        path: /etc/apt/keyrings
        state: directory
        mode: '0755'

    - name: Add Docker GPG key
      shell: |
        curl -fsSL https://download.docker.com/linux/ubuntu/gpg | \
        gpg --dearmor -o /etc/apt/keyrings/docker.gpg
      args:
        creates: /etc/apt/keyrings/docker.gpg

    - name: Add Docker repository
      apt_repository:
        repo: >
          deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.gpg]
          https://download.docker.com/linux/ubuntu
          {{ ansible_distribution_release }} stable
        state: present
        filename: docker

    - name: Install Docker
      apt:
        name: "{{ docker_packages }}"
        state: latest

    - name: Ensure Docker is running
      service:
        name: docker
        state: started
        enabled: yes

    - name: Add app user to docker group
      user:
        name: "{{ app_user }}"
        groups: docker
        append: yes

    - name: Reset SSH connection to apply docker group
      meta: reset_connection

  
    # ---------------- kubectl ----------------
    - name: Install kubectl
      get_url:
        url: "https://dl.k8s.io/release/{{ kubectl_version }}/bin/linux/amd64/kubectl"
        dest: /usr/local/bin/kubectl
        mode: '0755'

    - name: Verify kubectl
      command: kubectl version --client

    # ---------------- k3d ----------------
    - name: Install k3d
      shell: |
        curl -s https://raw.githubusercontent.com/k3d-io/k3d/main/install.sh | \
        TAG={{ k3d_version }} bash
      args:
        creates: /usr/local/bin/k3d

    - name: Verify k3d
      command: k3d version
      
    - name: Ensure correct ownership of app directory
      file:
        path: "{{ app_dir }}"
        state: directory
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        recurse: yes

    # ---------------- App ----------------
    - name: Create application directory
      file:
        path: "{{ app_dir }}"
        state: directory
        owner: "{{ app_user }}"
        group: "{{ app_user }}"

    - name: Clone FastAPI repository
      git:
        repo: "{{ repo_url }}"
        dest: "{{ app_dir }}"
        force: yes
        update: yes
      become_user: "{{ app_user }}"

    # ---------------- k3d Cluster ----------------
    - name: Create k3d cluster
      shell: k3d cluster create {{ k3d_cluster_name }}
      args:
        creates: "/home/{{ app_user }}/.k3d/kubeconfig-{{ k3d_cluster_name }}"
      become_user: "{{ app_user }}"

    # ---------------- Docker Compose ----------------
    - name: Launch application via Docker Compose
      shell: docker compose up -d
      args:
        chdir: "{{ app_dir }}"
      become_user: "{{ app_user }}"
